<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiscalopoly: NYC Edition</title>

    <!-- Dependencies -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Work+Sans:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

    <!-- Three.js + Physics -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "cannon-es": "https://unpkg.com/cannon-es@0.20.0/dist/cannon-es.js"
            }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>

    <style type="text/tailwindcss">
        @theme {
            --color-board-green: #1a472a;
            --color-board-cream: #f3e5ab;
            --color-gold: #c5a059;
            --color-neon-blue: #0ea5e9;
            --color-neon-red: #ef4444; 
            
            --font-serif: 'Cinzel', serif;
            --font-sans: 'Work Sans', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        body {
            @apply bg-zinc-950 text-white font-sans overflow-hidden;
        }

        .hud-panel {
            @apply bg-black/80 backdrop-blur-xl border border-white/10 p-4 rounded-xl shadow-2xl;
            border-left: 4px solid #c5a059;
            box-shadow: 0 8px 32px rgba(197, 160, 89, 0.1);
        }

        /* 3D Card Animation - Vintage Postcard Style */
        .card-container {
            perspective: 1000px;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 340px; height: 500px;
            pointer-events: none;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .card-container.card-active {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        .card-inner {
            position: relative;
            width: 100%; height: 100%;
            text-align: center;
            transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            transform-style: preserve-3d;
            transform: rotateY(180deg) scale(0.3) rotateZ(-15deg);
        }

        .card-active .card-inner {
            transform: rotateY(0deg) scale(1) rotateZ(0deg);
        }

        .card-face {
            @apply absolute w-full h-full backface-hidden rounded-lg overflow-hidden flex flex-col;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5), inset 0 0 0 2px rgba(255,255,255,0.1);
            background: linear-gradient(145deg, #1a1a1a 0%, #0f0f0f 100%);
        }
        
        .card-front {
            @apply text-white;
            border: 6px solid;
            position: relative;
        }

        .card-front::before {
            content: '';
            position: absolute;
            inset: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255,255,255,0.01) 10px,
                rgba(255,255,255,0.01) 20px
            );
            pointer-events: none;
        }
        
        .card-back {
            @apply flex items-center justify-center;
            transform: rotateY(180deg);
            background: linear-gradient(145deg, #c5a059 0%, #8b7355 100%);
        }

        /* District Themes - Vintage NYC Aesthetic */
        .district-fidi { 
            border-color: #0ea5e9;
            background: linear-gradient(145deg, #001a2e 0%, #000d1a 100%);
        }
        .district-midtown { 
            border-color: #64748b;
            background: linear-gradient(145deg, #1a1e2e 0%, #0d0f1a 100%);
        }
        .district-bk { 
            border-color: #a855f7;
            background: linear-gradient(145deg, #1a0a2e 0%, #0d051a 100%);
        }
        .district-ues { 
            border-color: #eab308;
            background: linear-gradient(145deg, #2e2200 0%, #1a1300 100%);
        }
        .district-corner {
            border-color: #c5a059;
            background: linear-gradient(145deg, #2a1a0a 0%, #150d05 100%);
        }

        .btn-action {
             @apply px-4 py-2 rounded font-bold text-xs uppercase tracking-wide border border-white/20 hover:bg-white/10 transition-colors flex items-center gap-2;
        }

        /* Vintage Typography for Tiles */
        .tile-label {
            font-family: 'Cinzel', serif;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        /* Pulse Animation for Active Player */
        @keyframes pulse-glow {
            0%, 100% { filter: drop-shadow(0 0 8px currentColor); }
            50% { filter: drop-shadow(0 0 16px currentColor); }
        }

        /* Stamp Effect for Card */
        .stamp-effect {
            animation: stamp 0.3s cubic-bezier(0.36, 0, 0.66, -0.56) forwards;
        }

        @keyframes stamp {
            0% { transform: scale(1.2) rotate(5deg); }
            50% { transform: scale(0.95) rotate(-3deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
    </style>
</head>

<body class="w-full h-screen">

    <!-- 3D Canvas -->
    <canvas id="game-canvas" class="absolute inset-0 z-0"></canvas>

    <!-- UI Overlay -->
    <div class="absolute inset-0 pointer-events-none p-6 flex flex-col justify-between z-10">

        <!-- Header -->
        <header class="flex justify-between items-start pointer-events-auto">
            <div class="hud-panel flex items-center gap-4 border-l-4 border-gold">
                <div
                    class="w-10 h-10 rounded-full bg-gold text-black flex items-center justify-center font-serif font-black text-xl">
                    F</div>
                <div>
                    <h1 class="font-serif text-2xl font-bold tracking-widest text-gold">FISCALOPOLY</h1>
                    <div class="text-xs font-mono text-zinc-400">NYC EDITION • YEAR <span id="ui-year">1</span>/20</div>
                </div>
            </div>

            <!-- Leaderboard -->
            <div id="leaderboard" class="hud-panel w-72 space-y-2">
                <!-- Init via JS -->
            </div>
        </header>

        <!-- Right Panel: CFO Desk (Finance Management) -->
        <div class="absolute right-6 top-32 bottom-32 w-80 hud-panel pointer-events-auto flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b border-white/10 pb-2">
                <h3 class="font-serif font-bold text-gold">CFO DESK</h3>
                <span id="cfo-player" class="text-xs uppercase font-bold text-zinc-400">Player 1</span>
            </div>

            <!-- Financial Stats -->
            <div class="bg-black/40 rounded p-3 mb-4 space-y-1 font-mono text-xs">
                <div class="flex justify-between"><span class="text-zinc-400">LIQUID CASH</span><span id="stat-cash"
                        class="text-green-400">$0</span></div>
                <div class="flex justify-between"><span class="text-zinc-400">ASSETS</span><span id="stat-assets"
                        class="text-blue-400">$0</span></div>
                <div class="flex justify-between"><span class="text-zinc-400">TAX LIABILITY</span><span id="stat-tax"
                        class="text-red-400">$0</span></div>
                <div class="w-full h-1 bg-zinc-800 mt-1 rounded overflow-hidden">
                    <div id="stat-risk-bar" class="h-full bg-red-500 w-0"></div>
                </div>
                <div class="text-[10px] text-right text-red-500 mt-0.5">AUDIT RISK: <span id="stat-risk">0%</span></div>
            </div>

            <!-- Actions -->
            <div class="flex-grow space-y-2 overflow-y-auto">
                <button onclick="Game.financeAction('invest')"
                    class="w-full text-left p-3 rounded bg-zinc-800/50 hover:bg-zinc-700 border border-blue-500/30 hover:border-blue-400 group transition-all">
                    <div class="text-xs font-bold text-blue-400 group-hover:text-blue-300">BUY S&P 500 ETF</div>
                    <div class="flex justify-between text-[10px] text-zinc-500 mt-1">
                        <span>Cost: $5,000</span>
                        <span>Asset Growth</span>
                    </div>
                </button>

                <button onclick="Game.financeAction('offshore')"
                    class="w-full text-left p-3 rounded bg-zinc-800/50 hover:bg-zinc-700 border border-purple-500/30 hover:border-purple-400 group transition-all">
                    <div class="text-xs font-bold text-purple-400 group-hover:text-purple-300">OFFSHORE SHELL CORP</div>
                    <div class="flex justify-between text-[10px] text-zinc-500 mt-1">
                        <span>Cost: $2,000</span>
                        <span class="text-red-400">Risk +15%</span>
                    </div>
                </button>

                <button onclick="Game.financeAction('charity')"
                    class="w-full text-left p-3 rounded bg-zinc-800/50 hover:bg-zinc-700 border border-gold/30 hover:border-gold group transition-all">
                    <div class="text-xs font-bold text-gold group-hover:text-yellow-200">CHARITY GALA</div>
                    <div class="flex justify-between text-[10px] text-zinc-500 mt-1">
                        <span>Cost: $1,000</span>
                        <span class="text-green-400">Reduce Tax</span>
                    </div>
                </button>
            </div>
        </div>

        <!-- Center Card Animation -->
        <div id="card-display" class="card-container pointer-events-auto">
            <div class="card-inner">
                <!-- Front -->
                <div class="card-face card-front p-6 district-fidi">
                    <!-- Decorative Corner Elements -->
                    <div class="absolute top-2 left-2 w-8 h-8 border-l-2 border-t-2 border-white/20"></div>
                    <div class="absolute top-2 right-2 w-8 h-8 border-r-2 border-t-2 border-white/20"></div>
                    <div class="absolute bottom-2 left-2 w-8 h-8 border-l-2 border-b-2 border-white/20"></div>
                    <div class="absolute bottom-2 right-2 w-8 h-8 border-r-2 border-b-2 border-white/20"></div>
                    
                    <div class="flex justify-between items-start mb-6 relative">
                        <h3 id="card-title" class="font-serif font-black text-2xl uppercase leading-tight tracking-wide">
                            Market<br>Crash</h3>
                        <div class="w-16 h-16 flex items-center justify-center rounded-full bg-black/40 border-2" id="card-icon-wrapper">
                            <i id="card-icon" data-lucide="trending-down" class="w-8 h-8 text-red-500"></i>
                        </div>
                    </div>
                    <div class="flex-grow flex items-center justify-center px-4">
                        <p id="card-desc" class="font-serif text-base text-center leading-relaxed text-zinc-200">
                            Your portfolio took a hit. Assets depreciate by 10%.
                        </p>
                    </div>
                    <div class="border-t border-white/30 pt-4 mt-4">
                        <div id="card-effect" class="text-center font-mono font-bold text-red-400 text-lg mb-4 tracking-wider">LOSE
                            $5,000 ASSETS</div>
                        <button onclick="Game.resolveCard()"
                            class="w-full py-3 bg-white text-black font-bold uppercase tracking-widest hover:bg-zinc-200 transition-all active:scale-95 rounded border-b-4 border-zinc-400">Continue →</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Controls -->
        <footer class="flex justify-center pointer-events-auto pb-8">
            <div class="relative">
                <button id="btn-roll" onclick="Game.rollDice()"
                    class="group relative px-16 py-5 bg-gradient-to-t from-red-900 to-red-600 rounded-xl shadow-[0_0_40px_rgba(220,38,38,0.4)] active:scale-95 transition-all">
                    <span
                        class="block font-serif font-black text-3xl text-white tracking-widest drop-shadow-md group-hover:scale-105 transition-transform">ROLL
                        DICE</span>
                    <div class="text-[10px] font-mono text-red-200 uppercase tracking-widest mt-1 opacity-70">End
                        Finance Phase</div>
                    <!-- Glow -->
                    <div
                        class="absolute inset-0 rounded-xl ring-2 ring-white/20 group-hover:ring-white/50 transition-all">
                    </div>
                </button>
            </div>
        </footer>
    </div>

    <!-- Start Screen -->
    <div id="setup-screen" class="fixed inset-0 z-50 bg-black flex items-center justify-center">
        <div class="text-center space-y-6 animate-fade-in">
            <h1 class="font-serif text-7xl text-gold mb-2">FISCALOPOLY</h1>
            <p class="text-zinc-400 uppercase tracking-widest text-sm">NYC Edition • Build Wealth. Evade Taxes.</p>
            <div class="flex gap-4 justify-center mt-8">
                <button onclick="Game.init(2)"
                    class="px-8 py-3 border border-white/20 hover:bg-white text-white hover:text-black font-bold transition-all">2
                    PLAYERS</button>
                <button onclick="Game.init(4)"
                    class="px-8 py-3 border border-white/20 hover:bg-white text-white hover:text-black font-bold transition-all">4
                    PLAYERS</button>
            </div>
        </div>
    </div>

    <!-- MAIN MODULE -->
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import * as CANNON from 'cannon-es';

        // --- GAME CONFIG ---
        const CONFIG = {
            boardSize: 48, // 12 per side
            districts: [
                { id: 'fidi', name: 'FiDi', color: 0x0ea5e9, tiles: [0, 11] }, // Bottom: Investment
                { id: 'midtown', name: 'Midtown', color: 0x64748b, tiles: [12, 23] }, // Right: Corporate
                { id: 'ues', name: 'Upper East', color: 0xeab308, tiles: [24, 35] }, // Top: Assets
                { id: 'bk', name: 'Brooklyn', color: 0xa855f7, tiles: [36, 47] } // Left: Creative
            ],
            salary: 2000 // Pass go
        };

        const STATE = {
            players: [],
            activeIdx: 0,
            turn: 1,
            phase: 'setup', // setup, finance, rolling, resolving
            isRolling: false
        };

        // --- 3D ENGINE ---
        const Engine = {
            // ... (Standard Three.js Setup recycled/optimized)
            scene: null, camera: null, renderer: null, controls: null, world: null,
            diceBodies: [], diceMeshes: [], spaceGroup: null,

            init() {
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x0a0a0a); // Deep dark

                this.camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 100);
                this.camera.position.set(0, 35, 40);

                this.renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('game-canvas'), antialias: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.shadowMap.enabled = true;
                this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;

                // Lights
                const amb = new THREE.AmbientLight(0xffffff, 0.4);
                this.scene.add(amb);

                // Spotlights for dramatic effect (NYC Night)
                const spot = new THREE.SpotLight(0xffeeb1, 1000);
                spot.position.set(15, 40, 15);
                spot.castShadow = true;
                spot.angle = 0.6;
                this.scene.add(spot);

                const neon = new THREE.PointLight(0x0ea5e9, 50, 40);
                neon.position.set(-10, 5, 10);
                this.scene.add(neon);

                // Physics
                this.world = new CANNON.World({ gravity: new CANNON.Vec3(0, -9.82 * 5, 0) });
                const floorBody = new CANNON.Body({ type: CANNON.Body.STATIC, shape: new CANNON.Plane() });
                floorBody.quaternion.setFromEuler(-Math.PI / 2, 0, 0);
                this.world.addBody(floorBody);

                // Controls
                this.controls = new OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enableDamping = true;
                this.controls.maxPolarAngle = Math.PI / 2.1;
                this.controls.minDistance = 20;

                this.buildBoard();
                this.createDice();
                this.loop();
                window.addEventListener('resize', () => this.resize());
            },

            resize() {
                this.camera.aspect = window.innerWidth / window.innerHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(window.innerWidth, window.innerHeight);
            },

            buildBoard() {
                // Table (Darker wood texture)
                const tableGeo = new THREE.BoxGeometry(30, 1, 30);
                const tableMat = new THREE.MeshStandardMaterial({ 
                    color: 0x0a0505, 
                    roughness: 0.7,
                    metalness: 0.1 
                });
                const table = new THREE.Mesh(tableGeo, tableMat);
                table.position.y = -0.6;
                table.receiveShadow = true;
                this.scene.add(table);

                // Board Surface (Vintage green felt with texture)
                const boardGeo = new THREE.BoxGeometry(22, 0.2, 22);
                const boardMat = new THREE.MeshStandardMaterial({ 
                    color: 0x1a472a, 
                    roughness: 0.95,
                    metalness: 0
                });
                const board = new THREE.Mesh(boardGeo, boardMat);
                board.receiveShadow = true;
                this.scene.add(board);

                // Add board border (golden trim)
                const borderGeo = new THREE.BoxGeometry(22.5, 0.25, 22.5);
                const borderMat = new THREE.MeshStandardMaterial({ 
                    color: 0xc5a059, 
                    roughness: 0.3,
                    metalness: 0.7
                });
                const border = new THREE.Mesh(borderGeo, borderMat);
                border.position.y = -0.05;
                this.scene.add(border);

                // Spaces with enhanced graphics
                this.spaceGroup = new THREE.Group();
                const count = 48;
                const offset = 10;
                const step = 20 / 12;

                // Property names for tiles
                const tileNames = this.generateTileNames();

                for (let i = 0; i < count; i++) {
                    let x, z, rot, color = 0xf3e5ab;

                    // Layout Logic (Perimeter)
                    if (i < 12) { x = -offset + (i * step) + step / 2; z = offset; rot = 0; }
                    else if (i < 24) { x = offset; z = offset - ((i - 12) * step) - step / 2; rot = -Math.PI / 2; }
                    else if (i < 36) { x = offset - ((i - 24) * step) - step / 2; z = -offset; rot = Math.PI; }
                    else { x = -offset; z = -offset + ((i - 36) * step) + step / 2; rot = Math.PI / 2; }

                    // Theme Colors by Side
                    if (i > 0 && i < 12) color = 0x0ea5e9; // FiDi Blue
                    if (i > 12 && i < 24) color = 0x64748b; // Midtown Slate
                    if (i > 24 && i < 36) color = 0xeab308; // UES Gold
                    if (i > 36 && i < 48) color = 0xa855f7; // BK Purple
                    if (i % 12 === 0) color = 0xffffff; // Corners

                    const w = step * 0.95;
                    const isCorner = i % 12 === 0;

                    // Tile Base with enhanced depth
                    const tileGeo = new THREE.BoxGeometry(w, 0.15, isCorner ? w : 2.5);
                    const tileMat = new THREE.MeshStandardMaterial({ 
                        color: color,
                        roughness: 0.8,
                        metalness: 0.2
                    });
                    const tile = new THREE.Mesh(tileGeo, tileMat);

                    tile.position.set(x, 0.15, z);
                    if (!isCorner) {
                        if (i >= 12 && i < 24) tile.rotation.y = Math.PI / 2;
                        if (i >= 36) tile.rotation.y = Math.PI / 2;
                    }

                    // Add border strip on top for non-corner tiles
                    if (!isCorner) {
                        const stripGeo = new THREE.BoxGeometry(w, 0.16, 0.6);
                        const stripMat = new THREE.MeshStandardMaterial({ 
                            color: color,
                            emissive: color,
                            emissiveIntensity: 0.3
                        });
                        const strip = new THREE.Mesh(stripGeo, stripMat);
                        strip.position.y = 0.08;
                        strip.position.z = -0.95;
                        tile.add(strip);

                        // Add text label using canvas texture
                        const canvas = document.createElement('canvas');
                        canvas.width = 256;
                        canvas.height = 128;
                        const ctx = canvas.getContext('2d');
                        
                        ctx.fillStyle = '#000000';
                        ctx.fillRect(0, 0, 256, 128);
                        
                        ctx.fillStyle = '#ffffff';
                        ctx.font = 'bold 16px Cinzel, serif';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        
                        const name = tileNames[i] || `SPACE ${i}`;
                        const words = name.split(' ');
                        if (words.length > 2) {
                            ctx.fillText(words.slice(0, 2).join(' '), 128, 50);
                            ctx.fillText(words.slice(2).join(' '), 128, 78);
                        } else if (words.length === 2) {
                            ctx.fillText(words[0], 128, 50);
                            ctx.fillText(words[1], 128, 78);
                        } else {
                            ctx.fillText(name, 128, 64);
                        }
                        
                        const texture = new THREE.CanvasTexture(canvas);
                        const labelGeo = new THREE.PlaneGeometry(w * 0.9, 0.5);
                        const labelMat = new THREE.MeshBasicMaterial({ 
                            map: texture, 
                            transparent: true 
                        });
                        const label = new THREE.Mesh(labelGeo, labelMat);
                        label.position.y = 0.16;
                        label.rotation.x = -Math.PI / 2;
                        tile.add(label);
                    } else {
                        // Corner tiles get special icons
                        const cornerCanvas = document.createElement('canvas');
                        cornerCanvas.width = 256;
                        cornerCanvas.height = 256;
                        const cornerCtx = cornerCanvas.getContext('2d');
                        
                        cornerCtx.fillStyle = this.getCornerColor(i);
                        cornerCtx.fillRect(0, 0, 256, 256);
                        
                        cornerCtx.fillStyle = '#000000';
                        cornerCtx.font = 'bold 24px Cinzel, serif';
                        cornerCtx.textAlign = 'center';
                        cornerCtx.textBaseline = 'middle';
                        
                        const cornerName = this.getCornerName(i);
                        const cornerWords = cornerName.split(' ');
                        cornerWords.forEach((word, idx) => {
                            cornerCtx.fillText(word, 128, 100 + idx * 35);
                        });
                        
                        const cornerTexture = new THREE.CanvasTexture(cornerCanvas);
                        const cornerLabelGeo = new THREE.PlaneGeometry(w * 0.9, w * 0.9);
                        const cornerLabelMat = new THREE.MeshBasicMaterial({ 
                            map: cornerTexture, 
                            transparent: true 
                        });
                        const cornerLabel = new THREE.Mesh(cornerLabelGeo, cornerLabelMat);
                        cornerLabel.position.y = 0.16;
                        cornerLabel.rotation.x = -Math.PI / 2;
                        tile.add(cornerLabel);
                    }

                    tile.userData = { id: i, type: isCorner ? 'corner' : 'prop', name: tileNames[i] };
                    tile.castShadow = true;
                    tile.receiveShadow = true;
                    this.spaceGroup.add(tile);
                }
                this.scene.add(this.spaceGroup);
            },

            generateTileNames() {
                return [
                    'GO', 'WALL ST', 'STOCK TIP', 'NYSE', 'TAX PENALTY', 'FERRY TERMINAL',
                    'BATTERY PARK', 'OPPORTUNITY', 'STONE ST', 'GOLDMAN SACHS', 'FED RESERVE', 'CITIGROUP',
                    'TIMES SQUARE', 'BROADWAY', 'AUDIT', 'ROCKEFELLER', 'MET LIFE', 'CHRYSLER BLDG',
                    'GRAND CENTRAL', 'CORPORATE TAX', 'MADISON AVE', 'CHANCE', 'FIFTH AVE', 'TRUMP TOWER',
                    'CENTRAL PARK', 'PLAZA HOTEL', 'MUSEUM MILE', 'FRICK MANSION', 'UPPER EAST', 'PROPERTY TAX',
                    'GRACIE MANSION', 'GUGGENHEIM', 'ASSET SEIZURE', 'CARNEGIE HILL', 'LUXURY TAX', 'BILLIONAIRES ROW',
                    'WILLIAMSBURG', 'BROOKLYN BRIDGE', 'DUMBO', 'PROSPECT PARK', 'SALES TAX', 'BARCLAYS CENTER',
                    'PARK SLOPE', 'IRS AUDIT', 'GOWANUS', 'SUNSET PARK', 'OFFSHORE ACCOUNT', 'RED HOOK'
                ];
            },

            getCornerColor(index) {
                const colors = ['#c5a059', '#0ea5e9', '#c5a059', '#a855f7'];
                return colors[index / 12];
            },

            getCornerName(index) {
                const names = ['GO COLLECT $2000', 'FEDERAL RESERVE', 'LUXURY TAX', 'IRS AUDIT'];
                return names[index / 12];
            },

            createDice() {
                const size = 0.8;
                // Textures would be loaded here, using colors for Pips
                const mat = new THREE.MeshStandardMaterial({ color: 0xff0000 });
                const geo = new THREE.BoxGeometry(size, size, size);

                for (let i = 0; i < 2; i++) {
                    const m = new THREE.Mesh(geo, mat);
                    m.castShadow = true;
                    this.scene.add(m);
                    this.diceMeshes.push(m);

                    const b = new CANNON.Body({ mass: 1, shape: new CANNON.Box(new CANNON.Vec3(size / 2, size / 2, size / 2)) });
                    b.position.set(0, -10, 0);
                    this.world.addBody(b);
                    this.diceBodies.push(b);
                }
            },

            spawnPlayer(id, color) {
                let geo;
                if (id === 0) geo = new THREE.CylinderGeometry(0.3, 0.5, 1.5, 16); // Top Hat
                else if (id === 1) geo = new THREE.ConeGeometry(0.5, 1.5, 8); // Ship
                else if (id === 2) geo = new THREE.BoxGeometry(0.8, 0.6, 1.2); // Car
                else geo = new THREE.SphereGeometry(0.5);

                const mat = new THREE.MeshStandardMaterial({ color: color, metalness: 0.6, roughness: 0.2 });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.set(0, 10, 0);
                mesh.castShadow = true;
                this.scene.add(mesh);
                return mesh;
            },

            throwDice(cb) {
                this.diceBodies.forEach((b, i) => {
                    b.position.set((Math.random() - 0.5) * 2, 10 + i * 2, (Math.random() - 0.5) * 2);
                    b.velocity.set(0, 0, 0);
                    b.angularVelocity.set(Math.random() * 20, Math.random() * 20, Math.random() * 20);
                    b.wakeUp();
                });

                setTimeout(() => {
                    const r1 = Math.ceil(Math.random() * 6);
                    const r2 = Math.ceil(Math.random() * 6);
                    cb(r1 + r2);
                }, 2000); // Visual wait
            },

            moveToken(mesh, spaceIdx, onComplete) {
                // Determine target world pos
                // In a perfect world we reference spaceGroup children map
                // We'll re-calculate for robustness based on index
                const count = 48;
                const offset = 10;
                const step = 20 / 12;
                let x, z;

                // (Same math as buildBoard)
                if (spaceIdx < 12) { x = -offset + (spaceIdx * step) + step / 2; z = offset; }
                else if (spaceIdx < 24) { x = offset; z = offset - ((spaceIdx - 12) * step) - step / 2; }
                else if (spaceIdx < 36) { x = offset - ((spaceIdx - 24) * step) - step / 2; z = -offset; }
                else { x = -offset; z = -offset + ((spaceIdx - 36) * step) + step / 2; }

                new TWEEN.Tween(mesh.position)
                    .to({ x: x, z: z, y: 0.8 }, 1000)
                    .easing(TWEEN.Easing.Cubic.InOut)
                    .onComplete(onComplete)
                    .start();

                // Hop
                new TWEEN.Tween(mesh.position)
                    .to({ y: 3 }, 500)
                    .yoyo(true)
                    .repeat(1)
                    .easing(TWEEN.Easing.Quadratic.Out)
                    .start();
            },

            loop() {
                requestAnimationFrame(() => this.loop());
                this.world.step(1 / 60);

                // Sync Dice
                this.diceBodies.forEach((b, i) => {
                    this.diceMeshes[i].position.copy(b.position);
                    this.diceMeshes[i].quaternion.copy(b.quaternion);
                });

                TWEEN.update();
                this.controls.update();
                this.renderer.render(this.scene, this.camera);
            }
        };

        // --- GAME LOGIC ---
        window.Game = {
            init(count) {
                document.getElementById('setup-screen').classList.add('hidden');
                Engine.init();

                const colors = [0xffd700, 0x0ea5e9, 0xff0000, 0x22c55e];
                for (let i = 0; i < count; i++) {
                    const m = Engine.spawnPlayer(i, colors[i]);
                    // Start at index 0
                    Engine.moveToken(m, 0);

                    STATE.players.push({
                        id: i,
                        name: `Player ${i + 1}`,
                        color: colors[i],
                        cash: 50000,
                        assets: 0,
                        taxLiability: 0,
                        auditRisk: 0,
                        space: 0,
                        mesh: m
                    });
                }
                this.updateUI();
                STATE.phase = 'finance';
            },

            financeAction(type) {
                const p = STATE.players[STATE.activeIdx];
                if (STATE.phase !== 'finance') return;

                if (type === 'invest' && p.cash >= 5000) {
                    p.cash -= 5000;
                    p.assets += 5000;
                    // Tax event? No immediate tax on purchase
                }
                if (type === 'offshore' && p.cash >= 2000) {
                    p.cash -= 2000;
                    p.assets += 2000; // Efficient
                    p.auditRisk += 15;
                }
                if (type === 'charity' && p.cash >= 1000) {
                    p.cash -= 1000;
                    p.taxLiability = Math.max(0, p.taxLiability - 3000);
                }
                this.updateUI();
            },

            rollDice() {
                if (STATE.isRolling) return;
                STATE.isRolling = true;

                Engine.throwDice((total) => {
                    const p = STATE.players[STATE.activeIdx];

                    // Move
                    p.space = (p.space + total) % CONFIG.boardSize;

                    // Passing Go?
                    if (p.space < total) { // wrapped
                        p.cash += CONFIG.salary;
                    }

                    Engine.moveToken(p.mesh, p.space, () => {
                        this.triggerSpace(p.space);
                        STATE.isRolling = false;
                    });
                });
            },

            triggerSpace(idx) {
                // Determine District based on idx
                let type = 'neutral';
                if (idx > 0 && idx < 12) type = 'fidi';
                if (idx > 12 && idx < 24) type = 'midtown';
                if (idx > 24 && idx < 36) type = 'ues';
                if (idx > 36 && idx < 48) type = 'bk';
                if (idx % 12 === 0) type = 'corner';

                // Generate Card Content based on type
                let title = "District Event";
                let desc = "Nothing happened.";
                let effect = { cash: 0, assets: 0, tax: 0 };
                let icon = "info";

                if (type === 'fidi') {
                    // Investment Zone
                    title = "Bull Market";
                    desc = "Your stocks soared. Capital Gains tax due.";
                    effect.cash = 4000;
                    effect.tax = 800;
                    icon = "trending-up";
                } else if (type === 'midtown') {
                    // Salary Zone
                    title = "Bonus Check";
                    desc = "Quarterly performance bonus received.";
                    effect.cash = 3000;
                    effect.tax = 1000; // High tax
                    icon = "briefcase";
                } else if (type === 'ues') {
                    // Asset Zone
                    title = "Property Tax";
                    desc = "You own too much land. Pay up.";
                    effect.cash = -2000;
                    icon = "home";
                } else if (type === 'bk') {
                    // Gig Zone
                    title = "Freelance Gig";
                    desc = "Paid in cash. Do you report it?";
                    effect.cash = 2500;
                    // Choice would go here, for now auto-report
                    effect.tax = 400;
                    icon = "coffee";
                } else if (type === 'corner') {
                    title = "Safe Haven";
                    desc = "Rest here. No audits today.";
                    icon = "shield";
                }

                // Apply logic
                const p = STATE.players[STATE.activeIdx];
                p.cash += effect.cash;
                p.assets += effect.assets;
                p.taxLiability += effect.tax;

                // Show Card with proper setup
                const card = document.getElementById('card-display');
                const cardInner = card.querySelector('.card-inner');
                const face = card.querySelector('.card-face');
                const iconWrapper = document.getElementById('card-icon-wrapper');
                
                // Reset state first
                card.classList.remove('card-active');
                cardInner.style.transform = 'rotateY(180deg) scale(0.3) rotateZ(-15deg)';
                
                // Update content
                document.getElementById('card-title').textContent = title;
                document.getElementById('card-desc').textContent = desc;
                
                let effectText = '';
                let effectColor = 'text-zinc-400';
                if (effect.cash > 0) {
                    effectText = `+ $${effect.cash.toLocaleString()}`;
                    effectColor = 'text-green-400';
                } else if (effect.cash < 0) {
                    effectText = `- $${Math.abs(effect.cash).toLocaleString()}`;
                    effectColor = 'text-red-400';
                } else if (effect.tax > 0) {
                    effectText = `TAX DUE: $${effect.tax.toLocaleString()}`;
                    effectColor = 'text-orange-400';
                }
                document.getElementById('card-effect').textContent = effectText;
                document.getElementById('card-effect').className = `text-center font-mono font-bold ${effectColor} text-lg mb-4 tracking-wider`;

                // Color Code and border style
                face.className = `card-face card-front p-6 district-${type}`;
                iconWrapper.className = `w-16 h-16 flex items-center justify-center rounded-full bg-black/40 border-2 border-${type === 'fidi' ? 'blue' : type === 'midtown' ? 'slate' : type === 'ues' ? 'yellow' : 'purple'}-400`;

                // Trigger animation with delay for proper rendering
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        card.classList.add('card-active');
                    });
                });

                this.updateUI();
                setTimeout(() => lucide.createIcons(), 100);
            },

            resolveCard() {
                const card = document.getElementById('card-display');
                
                // Ensure proper cleanup with animations
                const cardInner = card.querySelector('.card-inner');
                cardInner.style.transition = 'transform 0.4s ease-in';
                cardInner.style.transform = 'rotateY(180deg) scale(0.3) rotateZ(15deg)';
                
                setTimeout(() => {
                    card.classList.remove('card-active');
                    // Reset for next time
                    setTimeout(() => {
                        cardInner.style.transition = '';
                        cardInner.style.transform = '';
                    }, 300);
                }, 400);

                // Next turn
                STATE.activeIdx = (STATE.activeIdx + 1) % STATE.players.length;
                if (STATE.activeIdx === 0) {
                    STATE.turn++;
                    document.getElementById('ui-year').textContent = STATE.turn;
                }

                STATE.phase = 'finance';
                this.updateUI();

                // Cam follow
                const nextP = STATE.players[STATE.activeIdx];
                new TWEEN.Tween(Engine.controls.target)
                    .to({ x: nextP.mesh.position.x, z: nextP.mesh.position.z }, 1000)
                    .start();
            },

            updateUI() {
                const p = STATE.players[STATE.activeIdx];

                // CFO Desk
                document.getElementById('cfo-player').textContent = p.name;
                document.getElementById('cfo-player').style.color = '#' + p.color.toString(16);

                document.getElementById('stat-cash').textContent = '$' + p.cash.toLocaleString();
                document.getElementById('stat-assets').textContent = '$' + p.assets.toLocaleString();
                document.getElementById('stat-tax').textContent = '$' + p.taxLiability.toLocaleString();
                document.getElementById('stat-risk').textContent = p.auditRisk + '%';
                document.getElementById('stat-risk-bar').style.width = p.auditRisk + '%';

                // Leaderboard
                const lb = document.getElementById('leaderboard');
                lb.innerHTML = '<div class="text-xs uppercase font-bold text-zinc-500 mb-2">Net Worth Standings</div>';

                [...STATE.players].sort((a, b) => (b.cash + b.assets - b.taxLiability) - (a.cash + a.assets - a.taxLiability)).forEach(pl => {
                    const row = document.createElement('div');
                    row.className = "flex justify-between p-2 rounded text-xs";
                    if (pl.id === STATE.activeIdx) row.classList.add('bg-white/10', 'border', 'border-white/20');

                    const nw = pl.cash + pl.assets - pl.taxLiability;
                    row.innerHTML = `
                        <div class="flex items-center gap-2">
                             <div class="w-2 h-2 rounded-full" style="background:#${pl.color.toString(16)}"></div>
                             <span>${pl.name}</span>
                        </div>
                        <span class="font-mono text-gold">$${nw.toLocaleString()}</span>
                    `;
                    lb.appendChild(row);
                });
            }
        };

        // Init
        lucide.createIcons();

    </script>
</body>

</html>